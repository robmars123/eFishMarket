# ---------------------------------------------------------
# PIPELINE: API-ONLY BUILD & DEPLOY (React ignored)
# ---------------------------------------------------------
# This pipeline triggers ONLY when changes occur under /src/api/**
# React client under /src/client is intentionally ignored.
# ---------------------------------------------------------

trigger:
  branches:
    include:
      - master
  paths:
    include:
      - src/api/**        # Only trigger when API files change

pool: default

variables:
  # Azure App Service name for API deployment
  AZURE_WEBAPP_NAME: 'efm-onlineshop'

  # Azure Resource Group (required for Kudu credentials)
  AZURE_RESOURCE_GROUP: 'efm-onlineshop-rg'

  # Build configuration
  CONFIGURATION: 'Release'

  # .NET SDK version
  DOTNET_CORE_VERSION: '10.0.x'

  # API project directory (React is ignored)
  WORKING_DIRECTORY: 'src/api/EFM.Api'

  # Dedicated publish folder for API output
  PUBLISH_DIR: '$(Build.ArtifactStagingDirectory)/api'

# ---------------------------------------------------------
# PRODUCTION BUILD STAGE
# ---------------------------------------------------------
stages:
- stage: Production_Build
  displayName: "Production Build (API Only)"
  jobs:
  - job: Build
    displayName: "Restore, Build, Publish API"
    steps:

    # Install .NET SDK
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: $(DOTNET_CORE_VERSION)

    # Restore API dependencies
    - task: DotNetCoreCLI@2
      displayName: 'Restore API'
      inputs:
        command: 'restore'
        projects: '$(WORKING_DIRECTORY)/EFM.Api.csproj'

    # Build API project
    - task: DotNetCoreCLI@2
      displayName: 'Build API'
      inputs:
        command: 'build'
        projects: '$(WORKING_DIRECTORY)/EFM.Api.csproj'
        arguments: '--configuration $(CONFIGURATION)'

    # Publish API output to a clean folder
    - task: DotNetCoreCLI@2
      displayName: 'Publish API'
      inputs:
        command: 'publish'
        projects: '$(WORKING_DIRECTORY)/EFM.Api.csproj'
        arguments: '--configuration $(CONFIGURATION) --output "$(PUBLISH_DIR)"'

    # Debugging: list publish output
    - powershell: |
        Write-Host "Publish folder: $(PUBLISH_DIR)"
        if (-not (Test-Path "$(PUBLISH_DIR)")) { Write-Error "Publish folder missing"; exit 1 }
        Get-ChildItem -Path "$(PUBLISH_DIR)" -Recurse | ForEach-Object { Write-Host $_.FullName }
      displayName: 'List API publish output'

    # Publish raw API folder as artifact
    - task: PublishBuildArtifacts@1
      displayName: 'Publish API Artifact'
      inputs:
        PathtoPublish: '$(PUBLISH_DIR)'
        ArtifactName: 'webapp'
        publishLocation: 'Container'

# ---------------------------------------------------------
# PRODUCTION DEPLOY STAGE (DIRECT KUDU COPY)
# ---------------------------------------------------------
- stage: Production_Deploy
  displayName: "Production Deploy (API Only - Direct to wwwroot)"
  dependsOn: Production_Build
  jobs:
  - job: Deploy
    displayName: "Deploy API directly to wwwroot via Kudu"
    steps:

    # Download API artifact (raw publish folder)
    - task: DownloadBuildArtifacts@0
      displayName: 'Download API Artifact'
      inputs:
        artifactName: 'webapp'
        downloadPath: '$(Pipeline.Workspace)'

    # Install Azure CLI + Deploy via Kudu VFS API
    - task: AzureCLI@2
      displayName: "Deploy files to wwwroot using Kudu VFS API"
      inputs:
        azureSubscription: 'AzureSP-efm-onlineshop2'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $appName = "$(AZURE_WEBAPP_NAME)"
          $resourceGroup = "$(AZURE_RESOURCE_GROUP)"

          Write-Host "Fetching publishing profile..."
          $profile = az webapp deployment list-publishing-profiles `
              --name $appName `
              --resource-group $resourceGroup `
              --xml

          $xml = [xml]$profile
          $user = $xml.publishData.publishProfile[0].userName
          $pass = $xml.publishData.publishProfile[0].userPWD
          $kuduUrl = $xml.publishData.publishProfile[0].publishUrl.Replace(":443", "")

          Write-Host "Kudu URL: $kuduUrl"

          # Source folder (published API)
          $source = "$(Pipeline.Workspace)/webapp"

          Write-Host "Deploying files to Kudu..."
          $files = Get-ChildItem -Path $source -Recurse

          foreach ($file in $files) {
            if (-not $file.PSIsContainer) {
              $relativePath = $file.FullName.Replace($source, "").Replace("\", "/")
              $targetUrl = "https://$kuduUrl/api/vfs/site/wwwroot$relativePath"

              Write-Host "Uploading: $relativePath"
              Invoke-RestMethod -Uri $targetUrl `
                                -Method PUT `
                                -InFile $file.FullName `
                                -ContentType "application/octet-stream" `
                                -Credential (New-Object System.Management.Automation.PSCredential($user,(ConvertTo-SecureString $pass -AsPlainText -Force)))
            }
          }

          Write-Host "Deployment complete."